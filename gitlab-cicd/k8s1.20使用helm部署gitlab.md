# k8s1.20使用helm部署gitlab


## 下载镜像到私有仓库

```
busybox:latest
docker.io/bitnami/postgres-exporter:0.8.0-debian-10-r99
docker.io/bitnami/postgresql:11.9.0
docker.io/bitnami/redis:5.0.7-debian-9-r50
docker.io/bitnami/redis-exporter:1.3.5-debian-9-r23
gitlab/gitlab-runner:alpine-v13.8.0
jimmidyson/configmap-reload:v0.3.0
minio/mc:RELEASE.2018-07-13T00-53-22Z
minio/minio:RELEASE.2017-12-28T01-21-00Z
prom/prometheus:v2.15.2
quay.io/jetstack/cert-manager-cainjector:v0.10.1
quay.io/jetstack/cert-manager-controller:v0.10.1
registry.gitlab.com/gitlab-org/build/cng/alpine-certificates:20191127-r2
registry.gitlab.com/gitlab-org/build/cng/gitaly:v13.8.4
registry.gitlab.com/gitlab-org/build/cng/gitlab-container-registry:v2.13.1-gitlab
registry.gitlab.com/gitlab-org/build/cng/gitlab-exporter:8.0.0
registry.gitlab.com/gitlab-org/build/cng/gitlab-shell:v13.15.1
registry.gitlab.com/gitlab-org/build/cng/gitlab-sidekiq-ee:v13.8.4
registry.gitlab.com/gitlab-org/build/cng/gitlab-task-runner-ee:v13.8.4
registry.gitlab.com/gitlab-org/build/cng/gitlab-webservice-ee:v13.8.4
registry.gitlab.com/gitlab-org/build/cng/gitlab-workhorse-ee:v13.8.4
registry.gitlab.com/gitlab-org/build/cng/kubectl:1.13.12
registry.gitlab.com/gitlab-org/build/cng/cfssl-self-sign:1.2
```

## 添加 gitlab repo, 下载 chart 包

```
helm repo add gitlab https://charts.gitlab.io/
helm repo update
helm pull gitlab/gitlab
```

## 查看 values.yaml 及依赖的 requirements.yaml相关参数

[values.yaml](https://gitlab.com/gitlab-org/charts/gitlab/-/blob/master/values.yaml)

[requirements.yaml](https://gitlab.com/gitlab-org/charts/gitlab/-/blob/master/requirements.yaml)

## 创建 values.yaml

```
cat>values.yaml<<EOF
# Need to set certmanager-issuer.email before templating
certmanager-issuer:
  email: liujinye@hisuntech.com

# --- Global settings ---

global:
  image:
    repository: registry.hisun.netwarps.com/gitlab-cng
  kubectl: 
    image: 
      repository: registry.hisun.netwarps.com/gitlab-cng/kubectl
      tag: 1.13.12
    init: 
	  image:
	    repository: registry.hisun.netwarps.com/gitlab-cng/cfssl-self-sign
	    tag: 1.2
  certificates: 
    image: 
      repository: registry.hisun.netwarps.com/gitlab-cng/alpine-certificates
      tag: 20191127-r2


gitlab:
  #geo-logcursor: *custom
  gitaly:
    image:
      repository: registry.hisun.netwarps.com/gitlab-cng/gitaly
      tag: v13.8.4
    init: 
      image:
        repository: registry.hisun.netwarps.com/gitlab-cng/gitaly
        tag: v13.8.4
  gitlab-exporter:
    image:
      repository: registry.hisun.netwarps.com/gitlab-cng/gitlab-exporter
      tag: 8.0.0
    init: 
      image:
        repository: registry.hisun.netwarps.com/gitlab-cng/gitlab-exporter
        tag: 8.0.0
  # If global.grafana.enabled=true, uncomment below to set the custom image
  # gitlab-grafana: *custom
  gitlab-shell:
    image:
      repository: registry.hisun.netwarps.com/gitlab-cng/gitlab-shell
      tag: v13.15.1
    init: 
      image:
        repository: registry.hisun.netwarps.com/gitlab-cng/gitlab-shell
        tag: v13.15.1
  #mailroom: *custom
  migrations:
    image:
      repository:  registry.hisun.netwarps.com/gitlab-cng/gitlab-task-runner-ee
      tag: v13.8.4
    init: 
      image:
        repository: registry.hisun.netwarps.com/library/busybox
        tag: latest
  #operator: *custom
  sidekiq:
    image:
      repository: registry.hisun.netwarps.com/gitlab-cng/gitlab-sidekiq-ee
      tag: v13.8.4
    init: 
      image:
        repository: registry.hisun.netwarps.com/gitlab-cng/gitlab-sidekiq-ee
        tag: v13.8.4
  task-runner:
    image:
      repository: registry.hisun.netwarps.com/gitlab-cng/gitlab-task-runner-ee
      tag: v13.8.4
    init: 
      image:
        repository: registry.hisun.netwarps.com/gitlab-cng/gitlab-task-runner-ee
        tag: v13.8.4
  webservice:
    image:
      repository: registry.hisun.netwarps.com/gitlab-cng/gitlab-webservice-ee
      tag: v13.8.4
    init: 
      image:
        repository: registry.hisun.netwarps.com/gitlab-cng/gitlab-webservice-ee
        tag: v13.8.4
    workhorse:
      image: registry.hisun.netwarps.com/gitlab-cng/gitlab-workhorse-ee
      tag: v13.8.4

# --- Charts from requirements.yaml ---

certmanager:
  image:
    repository: registry.hisun.netwarps.com/jetstack/cert-manager-controller
    tag: v0.10.1
  cainjector:
    image:
      repository: registry.hisun.netwarps.com/jetstack/cert-manager-cainjector
      tag: v0.10.1

gitlab-runner:
  image: registry.hisun.netwarps.com/gitlab/gitlab-runner:alpine-v13.8.0
      
minio:
  image: registry.hisun.netwarps.com/minio/minio
  imageTag: RELEASE.2017-12-28T01-21-00Z
  init:
    image: 
      repository: registry.hisun.netwarps.com/minio/minio
      tag: RELEASE.2017-12-28T01-21-00Z
  minioMc:
    image: registry.hisun.netwarps.com/minio/mc
    tag: RELEASE.2018-07-13T00-53-22Z


nginx-ingress:
  enabled: false

registry:
  image:
    repository: registry.hisun.netwarps.com/gitlab-cng/gitlab-container-registry
    tag: v2.13.1-gitlab
  init: 
    image:
      repository: registry.hisun.netwarps.com/gitlab-cng/gitlab-container-registry
      tag: v2.13.1-gitlab

postgresql:
  image:
    registry: registry.hisun.netwarps.com
    repository: bitnami/postgresql
    tag: 11.9.0
  metrics:
    image:
      registry: registry.hisun.netwarps.com
      repository: bitnami/postgres-exporter
      tag: 0.8.0-debian-10-r99

prometheus:
  install: false

redis:
  image:
    registry: registry.hisun.netwarps.com
    repository: bitnami/redis
    tag: 5.0.7-debian-9-r50
  metrics:
    image:
      registry: registry.hisun.netwarps.com
      repository: bitnami/redis-exporter
      tag: 1.3.5-debian-9-r23

upgradeCheck: 
  image:
    repository: registry.hisun.netwarps.com/library/busybox
    tag: latest


# If global.grafana.enabled=true, uncomment below to set the custom image
# grafana:
#   <<: *custom
#   sidecar:
#     image: custom-repository:custom-tag
EOF
```

## 执行安装

```
helm upgrade --install gitlab gitlab-4.8.4.tgz \
  --namespace=gitlab --create-namespace \
  --timeout 600s \
  --set global.hosts.https=false \
  --set global.hosts.domain=apps164103.hisun.local \
  --set global.hosts.externalIP=172.26.164.104 \
  --set nginx-ingress.enabled=false \
  --set global.ingress.class=nginx \
  --set global.ingress.tls.enabled=false \
  --set certmanager.install=false \
  --set global.ingress.configureCertmanager=false \
  -f values.yaml
```

## 查看更新历史

```
helm history gitlab
```

## 回滚上一个版本

```
helm rollback gitlab
```

## 故障处理

### gitlab-runner 访问 gilab 服务 解析不到域名

#### 相关报错

```
gitlab runner  no such host
```

#### 解决方法

自建 dnsmasq server 添加泛解析

```
address=/apps164103.hisun.local/172.26.164.104
```

修改所有主机 /etc/resolv.conf 使用统一 自定义 dns server 

```
options timeout:2 attempts:3 rotate single-request-reopen
; generated by /usr/sbin/dhclient-script
nameserver 172.26.164.91
```

### gitlab-runner 访问 gitlab 报证书验证错误

#### 报错信息

```
x509: certificate is valid for ingress.local and not valid for other server defined using regex
```

#### 临时解决方法

禁用 tls 及 certmanager 管理证书

helm 安装是设置下面参数

```
  --set global.hosts.https=false \
  --set certmanager.install=false \
  --set global.ingress.configureCertmanager=false \
```

参考：

[官方helm部署指南](https://docs.gitlab.com/charts/installation/deployment.html)

[Gitlab Configure Charts using Globals](https://docs.gitlab.com/charts/charts/globals.html)

[GitLab cloud native Helm Chart](https://docs.gitlab.com/charts/)

[external-cert-manager-and-issuer-external](https://gitlab.com/gitlab-org/charts/gitlab/blob/master/doc/installation/tls.md#external-cert-manager-and-issuer-external)

[https://docs.gitlab.com/charts/advanced/external-nginx/index.html](https://docs.gitlab.com/charts/advanced/external-nginx/index.html)

[custom-images values.yaml](https://gitlab.com/gitlab-org/charts/gitlab/-/blob/master/examples/custom-images/values.yaml)